{% extends 'base.html' %}
{% block content %}

<div class="chat-shell">
    <div class="room-title">房間 {{ room }}</div>

    <div id="messages" class="messages"></div>

    <div class="chat-input-row">
        <input id="msg" type="text" placeholder="輸入訊息…">
        <button onclick="sendMessage()" class="btn-send">送出</button>
    </div>
</div>

<script>
    const socket = io();
    const room = "{{ room }}";
    const name = "{{ name }}";

    socket.emit("join", { room: room, name: name });

    function addMessage(data) {
        const box = document.getElementById("messages");
        let div = document.createElement("div");
        div.classList.add("bubble");

        div.innerHTML = `
            <span class="avatar">${data.avatar}</span>
            <span class="name">${data.name}</span>：
            <span>${data.text}</span>
            <div class="time">${data.time}</div>
        `;

        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    socket.on("message", data => addMessage(data));

    function sendMessage() {
        const msgInput = document.getElementById("msg");
        let text = msgInput.value.trim();
        if (!text) return;

        socket.emit("message", {
            room: room,
            name: name,
            text: text
        });

        msgInput.value = "";
    }

    document.getElementById("msg").addEventListener("keydown", e => {
        if (e.key === "Enter") sendMessage();
    });

    {% for m in messages %}
    addMessage({
        avatar: "{{ m['avatar'] }}",
        name: "{{ m['name'] }}",
        text: "{{ m['text'] }}",
        time: "{{ m['time'] }}"
    });
    {% endfor %}
</script>

{% endblock %}