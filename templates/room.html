<script>
    const socket = io();
    const room = "{{ room }}";
    const name = "{{ name }}";

    // å›ºå®šä½¿ç”¨è€…é ­åƒï¼ˆç™»å…¥å¾Œç”¢ç”Ÿä¸€æ¬¡ï¼‰
    const avatars = ["âœ¨","ğŸŒ™","ğŸŒ¸","â­","â˜ï¸","ğŸ’–","ğŸ¦„","ğŸ“","ğŸŒˆ"];
    const myAvatar = avatars[Math.floor(Math.random() * avatars.length)];

    socket.emit("join", { room, name, avatar: myAvatar });

    function createMessage(data) {
        const messagesDiv = document.getElementById("messages");

        const wrap = document.createElement("div");
        wrap.classList.add("bubble");

        // ä½ç½®ï¼šè‡ªå·± â†’ å³é‚Š
        if (data.name === name) {
            wrap.classList.add("me");
        } else {
            wrap.classList.add("other");
        }

        wrap.innerHTML = `
            <div class="bubble-avatar">${data.avatar}</div>
            <div>
                <strong>${data.name}</strong><br>
                ${data.text}
                <div class="bubble-time">${data.time}</div>
            </div>
        `;

        messagesDiv.appendChild(wrap);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // æ”¶è¨Šæ¯
    socket.on("message", data => {
        createMessage(data);
    });

    // ç™¼é€è¨Šæ¯
    function sendMessage() {
        const input = document.getElementById("message");
        const text = input.value.trim();
        if (!text) return;

        socket.emit("message", {
            room,
            name,
            avatar: myAvatar,
            text
        });

        input.value = "";
    }

    // Enter é€å‡º
    document.getElementById("message").addEventListener("keydown", e => {
        if (e.key === "Enter") {
            e.preventDefault();
            sendMessage();
        }
    });

    // è®€å–æ­·å²è¨Šæ¯
    {% for msg in messages %}
    createMessage({
        name: "{{ msg['name'] }}",
        text: "{{ msg['text'] }}",
        avatar: "{{ msg['avatar'] }}",
        time: "{{ msg['time'] }}"
    });
    {% endfor %}
</script>